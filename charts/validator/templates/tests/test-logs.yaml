apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "validator.fullname" . }}-test-logs"
  labels:
    
  annotations:
    "helm.sh/hook-weight": "3"
    "helm.sh/hook": test
spec:
  serviceAccountName: {{ include "validator.serviceAccountName" . }}-test
  containers:
    - name: test-ghost-logs
      image: ghcr.io/chronicleprotocol/buildtools:sha-c670bbf
      command:
        - /bin/sh
        - -c
        - |
          set -e
          POD_SELECTOR='app.kubernetes.io/name=ghost'
          echo "Waiting for ghost pod to be ready..."
          kubectl wait --for=condition=ready pod -l $POD_SELECTOR --namespace {{ .Release.Namespace }} --timeout=90s

          POD_NAME=$(kubectl get pods --namespace {{ .Release.Namespace }} -l $POD_SELECTOR -o jsonpath='{.items[0].metadata.name}')
          echo "Checking logs for pod $POD_NAME..."

          # Check for WATCHDOG initialization - indicates the app started and attempted config loading
          # Note: "Received data models" requires compatible on-chain config; WATCHDOG message works regardless
          if ! timeout 90s bash -c "until kubectl logs --namespace {{ .Release.Namespace }} \"\$0\" | grep -q \"WATCHDOG\"; do echo 'ghost logs: waiting for startup...'; sleep 5; done" "$POD_NAME"; then
            echo "TEST FAILED: Did not find 'WATCHDOG' in ghost logs within 90s."
            echo "--- Last 50 lines of log ---"
            kubectl logs --namespace {{ .Release.Namespace }} --tail=50 "$POD_NAME"
            exit 1
          fi
          echo "TEST PASSED: Ghost started successfully (WATCHDOG initialized)."
    {{- if .Values.vao.enabled }}
    - name: test-vao-logs
      image: ghcr.io/chronicleprotocol/buildtools:sha-c670bbf
      command:
        - /bin/sh
        - -c
        - |
          set -e
          POD_SELECTOR='app.kubernetes.io/name=vao'
          echo "Waiting for vao pod to be ready..."
          kubectl wait --for=condition=ready pod -l $POD_SELECTOR --namespace {{ .Release.Namespace }} --timeout=120s

          POD_NAME=$(kubectl get pods --namespace {{ .Release.Namespace }} -l $POD_SELECTOR -o jsonpath='{.items[0].metadata.name}')
          echo "Checking logs for pod $POD_NAME..."

          if ! timeout 90s bash -c "until kubectl logs --namespace {{ .Release.Namespace }} \"\$0\" | grep 'Configured model\" model=\"VAO::'; do echo 'vao logs: waiting for message...'; sleep 5; done" "$POD_NAME"; then
            echo "TEST FAILED: Did not find 'model=\"VAO::' in vao logs within 90s."
            echo "--- Last 100 lines of log ---"
            kubectl logs --namespace {{ .Release.Namespace }} --tail=10 "$POD_NAME"
            exit 1
          fi
          echo "TEST PASSED: Found 'model=\"VAO::' in vao logs."
    {{- end }}
  restartPolicy: Never